<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GPX Data Detail</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.1/chroma.min.js"></script>
    <!-- Include Leaflet.GPX plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.4.0/gpx.min.js"></script>
    <style>
        #map { height: 600px; }
    </style>
</head>
<body>
    <h1>GPX Data Detail - {{ gpx_data.id }}</h1>
    <div id="map"></div>

    <script>
        var map = L.map('map');
        map.getPane('tilePane').style.opacity = 0.4;
        var gpx;

        async function fetchGpx() {
            try {
                const response = await fetch('/map/gpx_data/{{ gpx_data.id }}/file/');
                gpx = await response.text();

                parseGpxAndSetMap(gpx);

                new L.GPX(gpx, {
                    async: true
                }).on('loaded', function(e) {
                    var gpxLayer = e.target;
                    var track = gpxLayer.getLayers()[0];
                
                    track.eachLayer(function (segment) {
                        var points = segment.getLatLngs();
                        for (var i = 0; i < points.length - 1; i++) {
                            var speed = calculateSpeed(points[i], points[i + 1]);
                            var color = getColorFromSpeed(speed);
                            L.polyline([points[i], points[i + 1]], { color: color }).addTo(map);
                        }
                    });
                
                    map.fitBounds(track.getBounds());
                }).addTo(map);
                
            } catch (error) {
                console.log('Error fetching GPX data:', error);
                console.error(error);
            }
        }
        function parseGpxAndSetMap(gpxData) {
            // Parse GPX data and extract coordinates
            var parser = new DOMParser();
            var xmlDoc = parser.parseFromString(gpxData, 'text/xml');
            var trkpts = xmlDoc.getElementsByTagName('trkpt');

            // Initialize variables for minimum and maximum latitude and longitude values
            var minLat, maxLat, minLon, maxLon;

            // Iterate through all trkpt elements to find minimum and maximum latitude and longitude
            for (var i = 0; i < trkpts.length; i++) {
                var lat = parseFloat(trkpts[i].getAttribute('lat'));
                var lon = parseFloat(trkpts[i].getAttribute('lon'));

                // Update minLat, maxLat, minLon, maxLon
                if (i === 0) {
                    minLat = maxLat = lat;
                    minLon = maxLon = lon;
                } else {
                    minLat = Math.min(minLat, lat);
                    maxLat = Math.max(maxLat, lat);
                    minLon = Math.min(minLon, lon);
                    maxLon = Math.max(maxLon, lon);
                }
            }

            // Calculate the center coordinates
            var centerLat = (minLat + maxLat) / 2;
            var centerLon = (minLon + maxLon) / 2;

            // Set the map view to focus on the center coordinates
            map.setView([centerLat, centerLon]);

            // Determine the zoom level to fit the entire route within the map bounds
            var bounds = L.latLngBounds([[minLat, minLon], [maxLat, maxLon]]);
            map.fitBounds(bounds);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // Add GPX data to the map
            new L.GPX(gpxData, {
                async: true
            }).on('loaded', function(e) {
                var gpxLayer = e.target;
                var track = gpxLayer.getLayers()[0];

                track.eachLayer(function(segment) {
                    // Process each segment of the GPX track, if needed
                });
            }).addTo(map);
        }


        fetchGpx();

        function calculateSpeed(point1, point2) {
            var distance = point1.distanceTo(point2); // Distance in meters
            var timeDiff = (point2.meta.time - point1.meta.time) / 1000; // Time difference in seconds
            var speed = distance / timeDiff; // Speed in meters per second
            return speed;
        }

        function getColorFromSpeed(speed) {
            var speedScale = chroma.scale(['blue', 'green', 'yellow', 'orange', 'red']).domain([0, 14]);
            return speedScale(speed).hex();
        }

        map.on('layeradd', function(event) {
            // Check if the added layer is a marker layer
            if (event.layer instanceof L.Marker) {
                // Remove the marker from the map
                map.removeLayer(event.layer);
            }
        });
    </script>
</body>
</html>
